<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DELTA - Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
            min-height: 100vh;
            font-family: 'Open Sans', sans-serif;
            padding: 2rem 1rem;
        }

        header {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-12px)
            }
        }

        .logo-delta {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #007BFF, #28A745);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 12px 30px rgba(0, 123, 255, .5);
        }

        .search-input {
            font-size: 1.4rem;
            padding: 1rem;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .card-clientes {
            background: white;
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, .22);
            overflow: hidden;
        }

        .table thead {
            background: #007BFF;
            color: white;
        }

        .points-badge {
            background: #28A745;
            color: white;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
        }

        .btn-nuevo {
            background: #28A745;
            font-size: 1.3rem;
            padding: 1rem 2rem;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-logout {
            background: #DC3545;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 700;
            color: white;
        }

        tr:hover {
            background: #f1f3f5 !important;
        }
    </style>
</head>

<body>

    <header class="bg-white rounded-pill shadow-lg p-4 mb-5">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-6 d-flex align-items:center gap-4">
                    <div class="logo-delta">Δ</div>
                    <h1 class="mb-0 display-5 fw-bold text-primary">DELTA</h1>
                </div>
                <div class="col-lg-6 text-end">
                    <div class="d-inline-flex align-items-center gap-3">
                        <i class="bi bi-person-circle fs-2 text-primary"></i>
                        <span id="nombreUsuario" class="fw-bold fs-5 text-dark">Cargando...</span>
                        <button class="btn btn-logout px-4" onclick="cerrarSesion()">
                            <i class="bi bi-box-arrow-right me-2"></i>Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <input type="text" id="buscarCliente" class="form-control search-input"
                    placeholder="Buscar por nombre o teléfono...">
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-nuevo text-white" data-bs-toggle="modal" data-bs-target="#modalCliente">
                    <i class="bi bi-person-plus-fill me-2"></i> Nuevo Cliente
                </button>
            </div>
        </div>

        <div class="card card-clientes">
            <div class="card-header bg-primary text-white text-center py-4">
                <h2 class="mb-0">Gestión de Clientes</h2>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                                <th>Puntos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaClientes">
                            <!-- Clientes cargados por JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div class="modal fade" id="modalCliente">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCliente">
                        <input type="hidden" id="idCliente">
                        <div class="mb-3">
                            <label>Nombre *</label>
                            <input type="text" id="nombre" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Teléfono</label>
                            <input type="tel" id="telefono" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Correo</label>
                            <input type="email" id="correo" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Puntos iniciales</label>
                            <input type="number" id="puntos" class="form-control" value="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary btn-lg" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let clientes = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nombreUsuario').textContent = localStorage.getItem('nombreUsuario') || 'Dueño';
            cargarClientes();

            // Búsqueda en tiempo real
            document.getElementById('buscarCliente').addEventListener('input', () => {
                const term = document.getElementById('buscarCliente').value.toLowerCase();
                const filtrados = clientes.filter(c =>
                    c.nombre.toLowerCase().includes(term) ||
                    (c.telefono && c.telefono.includes(term)) ||
                    (c.correo && c.correo.toLowerCase().includes(term))
                );
                renderTabla(filtrados);
            });
        });

        function cerrarSesion() {
            Swal.fire({ title: '¿Cerrar sesión?', icon: 'question', showCancelButton: true })
                .then(r => { if (r.isConfirmed) { localStorage.clear(); location.href = 'login.html'; } });
        }

        async function cargarClientes() {
            try {
                const res = await fetch('/api/clientes');
                const data = await res.json();
                if (data.success) {
                    clientes = data.clientes;
                    renderTabla(clientes);
                }
            } catch (err) {
                Swal.fire('Error', 'No se pudieron cargar clientes', 'error');
            }
        }

        function renderTabla(lista) {
            const tbody = document.getElementById('tablaClientes');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay clientes registrados</td></tr>';
                return;
            }

            lista.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${c.nombre}</strong></td>
                    <td>${c.telefono || '-'}</td>
                    <td>${c.correo || '-'}</td>
                    <td><span class="points-badge">${c.puntos || 0} pts</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editarCliente(${c.id_cliente})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarCliente(${c.id_cliente})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Abrir modal nuevo
        document.querySelector('[data-bs-target="#modalCliente"]').addEventListener('click', () => {
            document.getElementById('modalTitulo').textContent = 'Nuevo Cliente';
            document.getElementById('formCliente').reset();
            document.getElementById('idCliente').value = '';
        });

        // Guardar cliente
        document.getElementById('btnGuardar').addEventListener('click', async () => {
            const id = document.getElementById('idCliente').value;
            const cliente = {
                nombre: document.getElementById('nombre').value.trim(),
                telefono: document.getElementById('telefono').value.trim() || null,
                correo: document.getElementById('correo').value.trim() || null,
                puntos: parseInt(document.getElementById('puntos').value) || 0
            };

            if (!cliente.nombre) {
                Swal.fire('Error', 'El nombre es obligatorio', 'error');
                return;
            }

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/clientes/${id}` : '/api/clientes';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cliente)
                });

                const data = await res.json();

                if (data.success) {
                    Swal.fire('¡Éxito!', id ? 'Cliente actualizado' : 'Cliente creado', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
                    cargarClientes();
                }
            } catch (err) {
                Swal.fire('Error', 'No se pudo guardar', 'error');
            }
        });

        window.editarCliente = async (id) => {
            try {
                const res = await fetch('/api/clientes');
                const data = await res.json();
                const c = data.clientes.find(client => client.id_cliente == id);

                if (c) {
                    document.getElementById('modalTitulo').textContent = 'Editar Cliente';
                    document.getElementById('idCliente').value = c.id_cliente;
                    document.getElementById('nombre').value = c.nombre;
                    document.getElementById('telefono').value = c.telefono || '';
                    document.getElementById('correo').value = c.correo || '';
                    document.getElementById('puntos').value = c.puntos || 0;

                    new bootstrap.Modal(document.getElementById('modalCliente')).show();
                }
            } catch (err) {
                Swal.fire('Error', 'No se pudo cargar el cliente', 'error');
            }
        };

        window.eliminarCliente = (id) => {
            Swal.fire({
                title: '¿Eliminar cliente?',
                text: 'Esta acción es permanente',
                icon: 'warning',
                showCancelButton: true
            }).then(async (r) => {
                if (r.isConfirmed) {
                    try {
                        const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            Swal.fire('Eliminado', 'Cliente borrado', 'success');
                            cargarClientes();
                        }
                    } catch (err) {
                        Swal.fire('Error', 'No se pudo eliminar', 'error');
                    }
                }
            });
        };
    </script>
</body>

</html>