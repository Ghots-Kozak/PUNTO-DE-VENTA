<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeniPet - Mi Perfil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 2rem 1rem;
        }

        header {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-12px)
            }
        }

        .logo-circle {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 12px 30px rgba(79, 172, 254, .5);
        }

        .card-glow {
            background: white;
            border-radius: 2.8rem;
            padding: 3rem;
            box-shadow: 0 30px 80px rgba(0, 0, 0, .28);
            transition: all .4s;
        }

        .card-glow:hover {
            transform: translateY(-12px);
        }

        .icon-circle {
            width: 110px;
            height: 110px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2rem;
            color: white;
            box-shadow: 0 15px 40px rgba(102, 126, 234, .5);
            margin: 0 auto 1.5rem;
        }

        .pet-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 6px solid #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
        }

        .dropdown-menu {
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, .3);
            padding: 1.5rem;
        }

        .mascota-select {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 2.2rem;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(102, 126, 234, .45);
        }

        .mascota-select select {
            background: white;
            color: #333;
            border: none;
            border-radius: 25px;
            padding: 1rem 2rem;
            font-size: 1.3rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
        }
    </style>
</head>

<body>

    <!-- CABECERA -->
    <header class="bg-white rounded-pill shadow-lg p-4 mb-5">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-6 d-flex align-items-center gap-4">
                    <div class="logo-circle">Huella</div>
                    <h1 class="mb-0 display-5 fw-bold text-primary">VeniPet</h1>
                </div>
                <div class="col-lg-6 text-end">
                    <div class="d-inline-flex align-items-center gap-3 position-relative">

                        <div class="dropdown">
                            <a class="fw-bold fs-5 text-dark text-decoration-none dropdown-toggle"
                                data-bs-toggle="dropdown" id="nombreUsuario">
                                Cargando...
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end p-4">
                                <div id="infoUsuarioDropdown" class="text-start"></div>
                            </ul>
                        </div>
                        <button class="btn btn-danger rounded-pill px-4" onclick="cerrarSesion()">
                            <i class="bi bi-box-arrow-right me-2"></i>Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="row g-5">


            <div class="col-lg-5">

                <!-- DATOS DEL DUEÑO -->
                <div class="card-glow text-center mb-4">
                    <div class="icon-circle mb-3">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <h3 class="fw-bold text-primary mb-4">Datos del Dueño</h3>
                    <div id="infoDueno" class="text-start px-4">
                        <p class="text-muted">Cargando información...</p>
                    </div>
                </div>


                <div class="card-glow text-center">
                    <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                        <i class="bi bi-telephone-fill"></i>
                    </div>
                    <h4 class="fw-bold text-danger mb-4">Contacto de Emergencia</h4>
                    <p><strong>Nombre:</strong> María López Hernández</p>
                    <p><strong>Parentesco:</strong> Hermana</p>
                    <p><strong>Teléfono:</strong> 55 9876 5432</p>
                    <p><strong>Teléfono alternativo:</strong> 55 5555 1111</p>
                </div>
            </div>

            <!-- COLUMNA DERECHA: MASCOTAS -->
            <div class="col-lg-7">
                <div class="mascota-select mb-5">
                    <h2 class="fw-bold mb-3">Mis Mascotas</h2>
                    <p class="lead mb-4">Selecciona una para ver su información</p>
                    <select class="form-select form-select-lg w-75 mx-auto" id="selectMascota"
                        onchange="cambiarMascota(this.value)">
                        <option value="">Cargando mascotas...</option>
                    </select>
                </div>
                <div class="card-glow text-center" id="infoMascota">
                    <p class="text-muted">Selecciona una mascota para ver sus datos</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let usuario = null;
        let mascotas = [];

        // FUNCIÓN PARA CERRAR SESIÓN
        function cerrarSesion() {
            Swal.fire({
                title: '¿Cerrar sesión?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, salir',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('nombreUsuario');
                    location.href = 'login.html';
                }
            });
        }

        // CARGAR DATOS DEL USUARIO ACTUAL
        document.addEventListener('DOMContentLoaded', async () => {
            const nombreUsuario = localStorage.getItem('nombreUsuario');
            if (!nombreUsuario) {
                Swal.fire('Error', 'Debes iniciar sesión', 'error');
                location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch('/api/usuario-actual', {
                    headers: { 'x-nombre-usuario': nombreUsuario }
                });

                const data = await res.json();

                if (!data.success) {
                    Swal.fire('Error', data.msg || 'No se pudo cargar el perfil', 'error');
                    return;
                }

                usuario = data.usuario;
                mascotas = data.mascotas;


                document.getElementById('nombreUsuario').textContent = usuario.nombre_completo;

                // DROPDOWN PEQUEÑO
                document.getElementById('infoUsuarioDropdown').innerHTML = `
                    <h6 class="fw-bold"><i class="bi bi-person-circle"></i> ${usuario.nombre_completo}</h6>
                    <small class="text-muted">${usuario.correo}</small>
                `;


                document.getElementById('infoDueno').innerHTML = `
                    <p><strong>Nombre completo:</strong> ${usuario.nombre_completo}</p>
                    <p><strong>Teléfono:</strong> ${usuario.telefono || 'No registrado'}</p>
                    <p><strong>Correo:</strong> ${usuario.correo}</p>
                    <p><strong>Dirección:</strong> ${usuario.direccion || 'No registrada'}</p>
                    <p><strong>Colonia:</strong> ${usuario.colonia || 'N/A'}</p>
                    <p><strong>Código Postal:</strong> ${usuario.codigo_postal || 'N/A'}</p>
                `;

                // SELECT DE MASCOTAS
                const select = document.getElementById('selectMascota');
                select.innerHTML = '<option value="">Selecciona una mascota</option>';

                if (mascotas.length === 0) {
                    select.innerHTML = '<option value="">No tienes mascotas registradas</option>';
                    document.getElementById('infoMascota').innerHTML = '<p class="text-muted">Aún no has registrado ninguna mascota</p>';
                    return;
                }

                mascotas.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id_mascota;
                    opt.textContent = `${m.nombre} - ${m.especie} ${m.raza || ''}`;
                    select.appendChild(opt);
                });

                // Cargar primera mascota por defecto
                if (mascotas.length > 0) {
                    select.value = mascotas[0].id_mascota;
                    cambiarMascota(mascotas[0].id_mascota);
                }

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'No se pudo conectar al servidor', 'error');
            }
        });

        function cambiarMascota(id) {
            if (!id) return;
            const m = mascotas.find(x => x.id_mascota == id);
            if (!m) return;

            const foto = m.foto
                ? `<img src="/uploads/${m.foto}" class="pet-photo mb-4" alt="${m.nombre}">`
                : `<div class="icon-circle mb-4"><i class="bi bi-paw"></i></div>`;

            document.getElementById('infoMascota').innerHTML = `
                ${foto}
                <h3 class="fw-bold text-primary mb-4">${m.nombre}</h3>
                <div class="row text-start g-3">
                    <div class="col-md-6"><p><strong>Especie:</strong> ${m.especie}</p></div>
                    <div class="col-md-6"><p><strong>Raza:</strong> ${m.raza || 'N/A'}</p></div>
                    <div class="col-md-6"><p><strong>Sexo:</strong> ${m.sexo}</p></div>
                    <div class="col-md-6"><p><strong>Peso:</strong> ${m.peso_kg || 'N/A'} kg</p></div>
                    <div class="col-md-6"><p><strong>Color:</strong> ${m.color || 'N/A'}</p></div>
                    <div class="col-md-6"><p><strong>Esterilizado:</strong> ${m.esterilizado}</p></div>
                    <div class="col-md-6"><p><strong>Microchip:</strong> ${m.microchip}</p></div>
                    <div class="col-12"><p class="mt-3 fst-italic text-muted border-top pt-3"><strong>Notas:</strong> ${m.notas || 'Sin notas'}</p></div>
                </div>
            `;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>